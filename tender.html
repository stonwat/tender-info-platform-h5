<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>招标信息平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#4080FF',
                        neutral: '#6B7280',
                        light: '#F5F7FA',
                        dark: '#1D2129',
                        success: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-hover {
        @apply transition-all duration-300 hover:shadow-md;
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      .skeleton-loading {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
      .scroll-indicator {
        height: 4px;
        background: linear-gradient(to right, #165DFF, #4080FF);
        position: fixed;
        top: 0;
        left: 0;
        z-index: 100;
        transition: width 0.2s ease;
      }
      .error-toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #F53F3F;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        z-index: 1000;
        animation: fadeIn 0.3s, fadeOut 0.3s 3s forwards;
      }
      .status-badge {
        @apply px-1.5 py-0.5 text-xs rounded;
      }
      .status-bidding {
        @apply bg-green-100 text-green-800;
      }
      .status-closed {
        @apply bg-red-100 text-red-800;
      }
      .status-won {
        @apply bg-blue-100 text-blue-800;
      }
      .no-more-data {
        @apply py-4 text-center text-sm text-neutral;
      }
      .date-filter.active {
        @apply bg-primary text-white;
      }
      .skeleton-card {
        @apply bg-gray-100 rounded-xl p-4;
      }
      .skeleton-line {
        @apply h-4 bg-gray-200 rounded mb-3;
      }
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
      .serial-number {
        @apply flex items-center justify-center w-8 h-8 bg-primary/10 text-primary rounded-lg text-base font-medium;
      }
    }
  </style>
</head>

<body class="bg-gray-50 font-inter text-dark min-h-screen">
    <div id="app">
        <!-- 顶部滚动指示器 -->
        <div class="scroll-indicator" id="scrollIndicator"></div>

        <!-- 导航栏 -->
        <header class="bg-white shadow-sm sticky top-0 z-50">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <h1 class="text-lg font-bold">招标信息平台</h1>
                <div class="flex items-center gap-3">
                    <button id="refreshBtn" class="text-neutral hover:text-primary transition-colors">
                        <i class="fa fa-refresh"></i>
                    </button>
                </div>
            </div>

            <!-- 搜索框和地区筛选 -->
            <div class="px-4 pb-3">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="relative col-span-2">
                        <input id="searchInput" type="text" placeholder="搜索招标文件..."
                            class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary">
                        <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>

                    <!-- 地区筛选下拉框（地级市选项） -->
                    <div class="relative">
                        <select id="areaSelect"
                            class="w-full pl-3 pr-8 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary appearance-none bg-white">
                            <option value="">全部地区</option>
                            <option value="绥化市">绥化市</option>
                            <option value="大庆市">大庆市</option>
                            <option value="哈尔滨市">哈尔滨市</option>
                            <option value="齐齐哈尔市">齐齐哈尔市</option>
                            <option value="牡丹江市">牡丹江市</option>
                            <option value="鸡西市">鸡西市</option>
                            <option value="鹤岗市">鹤岗市</option>
                            <option value="双鸭山市">双鸭山市</option>
                            <option value="伊春市">伊春市</option>
                            <option value="七台河市">七台河市</option>
                            <option value="黑河市">黑河市</option>
                            <option value="大兴安岭地区">大兴安岭地区</option>
                        </select>
                        <i
                            class="fa fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主体内容 -->
        <main class="container mx-auto px-4 py-4">
            <!-- 筛选标签（仅保留地区筛选） -->
            <div id="filterTags" class="flex flex-wrap gap-2 mb-4 hidden">
                <span id="regionTag"
                    class="px-2 py-1 bg-primary/10 text-primary text-xs rounded-full flex items-center">
                    地区：<span class="ml-1 region-tag-value">绥化市</span>
                    <button class="ml-1 text-primary/70 hover:text-primary"><i class="fa fa-times-circle"></i></button>
                </span>
                <button id="clearAllFilters" class="text-xs text-neutral hover:text-primary">
                    清除全部
                </button>
            </div>

            <!-- 列表计数 -->
            <div class="text-xs text-neutral mb-4 flex justify-between items-center">
                <span>共找到 <span id="totalCount" class="text-primary font-medium">0</span> 条信息</span>
                <span id="displayRange" class="hidden">显示 0-0 条</span>
            </div>

            <!-- 列表内容 -->
            <ul id="tenderList" class="space-y-3">
                <li id="loadingIndicator" class="py-8 text-center">
                    <div
                        class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent">
                    </div>
                    <p class="mt-2 text-sm text-neutral">加载中...</p>
                </li>
            </ul>
        </main>

        <!-- 页脚 -->
        <footer class="py-4 text-center text-xs text-neutral border-t border-gray-100">
            <p>© 2025 招标信息平台. 保留所有权利.</p>
        </footer>

        <!-- 回到顶部按钮 -->
        <button id="backToTopBtn"
            class="fixed bottom-6 right-6 bg-primary text-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center transition-all z-50 opacity-0 invisible">
            <i class="fa fa-arrow-up"></i>
        </button>
    </div>

    <script>
        // 应用状态（仅保留地区筛选和当天查询）
        const appState = {
            tenders: [],
            currentPage: 1,
            itemsPerPage: 10,
            totalItems: 0,
            isLoading: true,
            hasMore: true,
            searchQuery: '',
            selectedRegion: '', // 对齐数据库`region`字段
            // apiBaseUrl: 'http://117.72.196.106:8088/api/tenders'
            apiBaseUrl: 'http://localhost:8088/api/tenders'
        };

        // DOM 元素（移除日期筛选相关）
        const elements = {
            tenderList: document.getElementById('tenderList'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            emptyState: null,
            totalCount: document.getElementById('totalCount'),
            displayRange: document.getElementById('displayRange'),
            searchInput: document.getElementById('searchInput'),
            refreshBtn: document.getElementById('refreshBtn'),
            backToTopBtn: document.getElementById('backToTopBtn'),
            scrollIndicator: document.getElementById('scrollIndicator'),
            areaSelect: document.getElementById('areaSelect'),
            filterTags: document.getElementById('filterTags'),
            regionTag: document.getElementById('regionTag'),
            regionTagText: document.querySelector('.region-tag-value'),
            clearAllFilters: document.getElementById('clearAllFilters'),
            regionTagClose: document.querySelector('#regionTag button')
        };

        // 初始化应用
        function initApp() {
            // 从URL获取地区参数
            const urlParams = new URLSearchParams(window.location.search);
            const regionFromUrl = urlParams.get('region');
            if (regionFromUrl) {
                appState.selectedRegion = regionFromUrl;
                elements.areaSelect.value = regionFromUrl;
            }

            loadInitialData();
            setupEventListeners();
        }

        // 加载初始数据（固定当天查询）
        function loadInitialData() {
            setLoading(true);
            appState.currentPage = 1;
            showSkeletonLoading();

            fetchTenderData()
                .then(data => {
                    appState.tenders = data.content;
                    appState.totalItems = data.totalElements;
                    appState.hasMore = (appState.currentPage * appState.itemsPerPage) < appState.totalItems;
                    renderTenders();
                    setLoading(false);
                    updateFilterTags();
                })
                .catch(error => {
                    console.error('加载数据失败:', error);
                    setLoading(false);
                    showEmptyState(true);
                    showErrorToast('加载数据失败，请稍后重试');
                });
        }

        // 请求数据（固定当天日期）
        function fetchTenderData() {
            const today = new Date();
            const todayStr = formatDateForApi(today);

            const params = {
                page: appState.currentPage - 1,
                size: appState.itemsPerPage,
                region: appState.selectedRegion || undefined,
                startDate: todayStr,  // 固定当天查询
                endDate: todayStr,    // 固定当天查询
                keyword: appState.searchQuery.trim() || undefined
            };

            Object.keys(params).forEach(key => params[key] === undefined && delete params[key]);

            return axios.get(`${appState.apiBaseUrl}/filter`, { params })
                .then(response => response.data)
                .catch(error => {
                    console.error('请求招标数据失败:', error.response?.data || error.message);
                    throw error;
                });
        }

        // 加载更多数据
        function loadMoreData() {
            if (appState.isLoading || !appState.hasMore) return;
            setLoading(true);
            appState.currentPage++;

            fetchTenderData()
                .then(data => {
                    appState.totalItems = data.totalElements;
                    appState.hasMore = (appState.currentPage * appState.itemsPerPage) < appState.totalItems;
                    appState.tenders.push(...data.content); // 追加数据
                    console.log(appState.tenders,'tenders',typeof(appState.tenders[0].endTime) )
                    renderTenders(true);
                    setLoading(false);
                })
                .catch(error => {
                    console.error('加载更多数据失败:', error);
                    setLoading(false);
                    appState.currentPage--;
                    showErrorToast('加载更多数据失败，请稍后重试');
                });
        }

        // 渲染招标列表（展示 region 并处理为地级市）
        function renderTenders(append = false) {
            const { tenders, currentPage, itemsPerPage, totalItems } = appState;
            const start = (currentPage - 1) * itemsPerPage;
            const end = Math.min(start + itemsPerPage, totalItems);

            elements.totalCount.textContent = totalItems;
            elements.displayRange.textContent = totalItems > 0 ? `显示 ${start + 1}-${end} 条` : '';
            elements.displayRange.classList.toggle('hidden', totalItems === 0);

            if (!append) elements.tenderList.innerHTML = '';
            else {
                const loadingIndicator = elements.tenderList.querySelector('.loading-indicator');
                const noMoreIndicator = elements.tenderList.querySelector('.no-more-data');
                if (loadingIndicator) loadingIndicator.remove();
                if (noMoreIndicator) noMoreIndicator.remove();
            }

            if (tenders.length > 0) {
                showEmptyState(false);
                tenders.forEach((tender, index) => {
                    elements.tenderList.appendChild(createTenderListItem(tender, index));
                });
                if (appState.hasMore) elements.tenderList.appendChild(createLoadingMoreIndicator());
                else if (appState.currentPage > 1) elements.tenderList.appendChild(createNoMoreDataIndicator());
            } else {
                showEmptyState(true);
            }
        }
        // 创建加载更多指示器
        function createLoadingMoreIndicator() {
            const indicator = document.createElement('li');
            indicator.className = 'py-4 text-center loading-indicator';
            indicator.innerHTML = `
        <p class="text-sm text-neutral">
            <i class="fa fa-angle-down mr-1 animate-bounce"></i> 上拉加载更多
        </p>
    `;
            return indicator;
        }

        // 创建"没有更多数据"指示器
        function createNoMoreDataIndicator() {
            const indicator = document.createElement('li');
            indicator.className = 'no-more-data';
            indicator.innerHTML = `
        <div class="inline-flex items-center gap-2">
            <i class="fa fa-check-circle text-success"></i>
            <span>已加载全部数据</span>
        </div>
    `;
            return indicator;
        }

        // 创建列表项（展示 region 并处理为地级市）
        function createTenderListItem(tender, index) {
            const listItem = document.createElement('li');
            listItem.className = 'bg-white rounded-xl shadow-sm overflow-hidden card-hover fade-in';
            listItem.style.animationDelay = `${index * 0.05}s`;

            const serialNumber = (appState.currentPage - 1) * appState.itemsPerPage + index + 1;
            const targetUrl = tender.url ? tender.url : '#';

            // 处理地区为地级市格式（如“绥化市市本级”→“绥化市”）
            const regionText = formatRegion(tender.region);

            listItem.innerHTML = `
        <a href="${targetUrl}" target="_blank" rel="noopener noreferrer" class="block p-4">
          <div class="flex items-start gap-3">
            <div class="serial-number">${serialNumber}</div>
            <div class="bg-primary/10 text-primary p-2 rounded-lg">
              <i class="fa fa-file-text-o text-lg"></i>
            </div>
            <div class="flex-grow">
              <h3 class="font-medium text-base mb-1 line-clamp-2">${tender.title}</h3>
              <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-neutral">
                <span><i class="fa fa-money text-primary mr-1"></i>预算：${tender.budget}</span>
                <span><i class="fa fa-list-alt text-primary mr-1"></i>标的：${tender.matter}</span>
                <span><i class="fa fa-tag text-primary mr-1"></i>种类：${tender.category}</span>
                <span><i class="fa fa-calendar-o mr-1"></i>日期：${formatDate(tender.date)}</span>
                <span><i class="fa fa-clock-o mr-1"></i>开始：${tender.startTime}</span>
                <span><i class="fa fa-clock-o mr-1"></i>结束：${tender.endTime}</span>
                <span><i class="fa fa-map-marker text-primary mr-1"></i>地区：${regionText}</span>
              </div>
            </div>
            <i class="fa fa-angle-right text-neutral self-center"></i>
          </div>
        </a>
      `;
            return listItem;
        }

        // 处理地区为地级市（如“绥化市市本级”→“绥化市”）
        function formatRegion(region) {
            if (!region) return '';
            // 提取“市本级”前面的市名
            if (region.endsWith('市本级')) {
                return region.replace('市本级', '市');
            }
            // 其他情况直接返回（可扩展处理县级市/区）
            return region;
        }

        // 日期格式化
        function formatDate(dateString) {
            if (!dateString) return '';
            if (typeof dateString === 'string' && dateString.includes('-')) return dateString;
            const date = new Date(dateString);
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }

        // 日期格式化（API用）
        function formatDateForApi(date) {
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }

        // 骨架屏
        function showSkeletonLoading() {
            elements.tenderList.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const skeleton = document.createElement('li');
                skeleton.className = 'skeleton-card animate-pulse';
                skeleton.innerHTML = `
                    <div class="skeleton-line w-3/4"></div>
                    <div class="flex gap-3 mt-3">
                        <div class="skeleton-line w-1/4"></div>
                        <div class="skeleton-line w-1/4"></div>
                    </div>
                `;
                elements.tenderList.appendChild(skeleton);
            }
        }

        // 错误提示
        function showErrorToast(message) {
            const existingToast = document.querySelector('.error-toast');
            if (existingToast) existingToast.remove();
            const toast = document.createElement('div');
            toast.className = 'error-toast';
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa fa-exclamation-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // 加载状态
        function setLoading(isLoading) {
            appState.isLoading = isLoading;
        }

        // 空状态
        function showEmptyState(show) {
            if (show) {
                if (!elements.emptyState) {
                    const emptyState = document.createElement('li');
                    emptyState.id = 'emptyState';
                    emptyState.className = 'py-16 text-center';
                    emptyState.innerHTML = `
                        <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                            <i class="fa fa-search text-3xl text-gray-300"></i>
                        </div>
                        <p class="text-neutral">暂无匹配的招标信息</p>
                        <button id="reloadBtn" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg text-sm">
                            重新加载
                        </button>
                    `;
                    elements.emptyState = emptyState;
                    elements.reloadBtn = document.getElementById('reloadBtn');
                }
                elements.tenderList.innerHTML = '';
                elements.tenderList.appendChild(elements.emptyState);
                if (elements.reloadBtn) {
                    elements.reloadBtn.addEventListener('click', () => loadInitialData());
                }
            } else if (elements.emptyState && elements.emptyState.parentNode) {
                elements.tenderList.removeChild(elements.emptyState);
            }
        }

        // 更新筛选标签（仅处理地区）
        function updateFilterTags() {
            const hasFilters = appState.selectedRegion || appState.searchQuery.trim();
            elements.filterTags.classList.toggle('hidden', !hasFilters);

            elements.regionTag.classList.toggle('hidden', !appState.selectedRegion);
            if (appState.selectedRegion) {
                elements.regionTagText.textContent = appState.selectedRegion;
            }

            appState.hasMore = appState.currentPage * appState.itemsPerPage < appState.totalItems;
        }

        // 事件监听（移除日期筛选相关）
        function setupEventListeners() {
            // 搜索
            elements.searchInput.addEventListener('input', debounce(function () {
                appState.searchQuery = this.value;
                appState.currentPage = 1;
                loadInitialData();
            }, 500));

            // 地区筛选
            elements.areaSelect.addEventListener('change', function () {
                appState.selectedRegion = this.value;
                appState.currentPage = 1;
                loadInitialData();
            });

            // 刷新
            elements.refreshBtn.addEventListener('click', () => loadInitialData());

            // 清除地区筛选
            elements.regionTagClose.addEventListener('click', function () {
                appState.selectedRegion = '';
                elements.areaSelect.value = '';
                appState.currentPage = 1;
                loadInitialData();
            });

            // 清除全部筛选
            elements.clearAllFilters.addEventListener('click', function () {
                appState.selectedRegion = '';
                appState.searchQuery = '';
                appState.currentPage = 1;

                elements.areaSelect.value = '';
                elements.searchInput.value = '';

                loadInitialData();
            });

            // 回到顶部
            elements.backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // 滚动事件
            window.addEventListener('scroll', function () {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrollPercentage = (scrollTop / scrollHeight) * 100;
                elements.scrollIndicator.style.width = `${scrollPercentage}%`;

                if (scrollTop > 300) {
                    elements.backToTopBtn.classList.remove('opacity-0', 'invisible');
                    elements.backToTopBtn.classList.add('opacity-100', 'visible');
                } else {
                    elements.backToTopBtn.classList.add('opacity-0', 'invisible');
                    elements.backToTopBtn.classList.remove('opacity-100', 'visible');
                }

                const bottomOffset = 100;
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - bottomOffset) {
                    loadMoreData();
                }
            });
        }

        // 防抖函数
        function debounce(func, delay) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>